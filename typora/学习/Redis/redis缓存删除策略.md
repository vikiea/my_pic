# 删除策略

# Redis的过期键删除策略Redis的过期键删除策略

Redis作为一个高性能的内存NoSQL数据库，其容量受到最大内存限制的限制。

Redis运行时产生的内存，包括：

- 保存键值对所需的开销
- 过期Key所占空间
- 渐进式Rehash导致未及时删除的空间Redis管理数据，包括底层数据结构开销，客户端信息，读写缓冲区等主从复制，bgsave时的额外开销

## 一、立即删除(主动)

在设置键的过期时间时，创建一个回调事件，当过期时间达到时，由时间处理器自动执行键的删除操作。

#### 优缺点：

**优点：**它保证过期键值会在过期后马上被删除，其所占用的内存也会随之释放。

**缺点：**对cpu是最不友好的。因为删除操作会占用cpu的时间，如果刚好碰上了cpu正在做排序等计算的时候，就会给cpu造成额外的压力。而且目前redis事件处理器对时间事件的处理方式–无序链表，查找一个key的时间复杂度为O(n)，所以并不适合用来处理大量的时间事件。

## 二、惰性删除(被动)

某个键值过期后，此键值不会马上被删除，而是等到下次被使用的时候，才会被检查到过期，此时才能得到删除。
![null](https://gitee.com/vikieq/my_pic/raw/master/uPic/2021/10/11/m_6c10bd74323f6d0f227a75ed7ace73e3_r.png)

#### 优缺点：

**缺点：**
浪费内存。（比如按时间点来更新的数据，过了这个时间点就不访问这个key了，就造成了内存不能被释放）

## 三、定时删除（主动）

每隔一段时间执行一次删除操作，并通过限制删除操作执行的时长和频率，来减少删除操作对cpu的影响。另一方面定时删除也有效的减少了因惰性删除带来的内存浪费。

#### 定期删除策略的实现

每当redis服务器的服务器周期性操作serverCron函数执行时，activeExpireCycle函数被调用，分多次遍历服务器

中的各个数据库，从数据库的expires字典中随机检查一部分键的过期时间，并删除其中的过期键。

activeExpireCycle函数的工作模式：

a、函数每次运行时，都从一定数量的数据库中取出一定数量的随机键进行检查，并删除其中的过期键。

b、全局变量current_db会记录当前activeExpireCycle函数检查的进度，并在下一次activeExpireCycle函数调用时，

接着上一次的进度进行处理。

c、随着activeExpireCycle函数的不断执行，服务器中的所有数据库都会被检查一遍，这时函数将current_db变量

重置为0，然后再次开始新一轮的检查工作。

#### 过期Key清理算法

`Redis`过期`Key`清理的机制对清理的`频率`和`最大时间`都有限制，在尽量不影响正常服务的情况下，进行过期Key的清理，以达到长时间服务的性能最优。

Redis会周期性的随机测试一批设置了过期时间的key并进行处理。测试到的已过期的key将被删除。具体的算法如下:

Redis配置项`hz`定义了`serverCron`任务的执行周期，默认为10，即CPU空闲时每秒执行10次;每次过期key清理的时间不超过`CPU`时间的`25%`，

即若hz=1，则一次清理时间最大为250ms，

若hz=10，则一次清理时间最大为25ms;

清理时依次遍历所有的db;从db中随机取20个key，判断是否过期，若过期，则逐出;若有5个以上key过期，则重复步骤4，否则遍历下一个db;在清理过程中，若达到了25%CPU时间，退出清理过程;

这是一个基于概率的简单算法，基本的假设是抽出的样本能够代表整个key空间，redis持续清理过期的数据直至将要过期的key的百分比降到了25%以下。

由于算法采用的随机取key判断是否过期的方式，故几乎不可能清理完所有的过期Key。

调高hz参数可以提升清理的频率，过期key可以更及时的被删除，但hz太高会增加CPU时间的消耗。

文档更新时间: 2021-04-24 16:00  作者：admin