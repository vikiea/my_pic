# 积分业务问题总结
## 发现问题汇总
## 遗留问题汇总
#### 更改【核心数据每日汇总】-【当日提现积分】的统计方法
##### http://qs.2345.net/action/tasks.php?act=detail&id=ZDJkAQVQCnAJAgEKUQY=
##### 问题发现
解决此问题时，发现数据库中“第三方封禁-收”day_freeze，实际的意义与描述不符。
在积分后台》推广数据每日汇总》积分每日收支汇总中的第三方封禁-收，实际是day_freeze-day_ziyou_freeze
##### 原因排查
首先确认day_freeze的数据来源，分别去`cron/generate_background_data_after_check.php`,
`cron/score_temp_to_normal.php`排查，在后者中发现有计算积分汇总的代码，最后发现其汇总是通过积分类型来的，然后day_freeze字段包含了有自有封禁和第三方封禁的各种类型，确认day_freeze字段确实代表的是自有+第三方封禁积分

#### 解封操作问题排查
##### http://qs.2345.net/action/tasks.php?act=detail&id=ZmJkAQVQCnAJAgIJWgY=
##### 问题发现
页面URL：http://jifen.2345.com/2345_jifen_htgl/freeze_manual.php。
给用户的（用户名： 846065770、269053165@qq.com）‘2345王牌浏览器’、‘2345加速浏览器’、‘2345加速浏览器（安全版）’进行解封操作，操作完成后在页面显示 操作结果是0（0代表为解封状态），即解封成功。但是用户前端2345加速浏览器依然显示是‘已封禁’。
查询后发现‘2345加速浏览器（安全版）’并未解封成功，导致前端2345加速浏览器依然是 已封禁的状态。
备注说明：浏览器共有3款‘2345王牌浏览器’‘2345加速浏览器’、‘2345加速浏览器（安全版）’，后台分3个产品展示，但是用户前端是统一显示为‘2345加速浏览器 ’，只要后台有一款在封禁状态，前端就显示为已封禁。
##### 原因排查
经排查：
1. 在后台进行封禁操作时，会将三个产品在my_freeze，my_freeze_manual表的置为1，以及各个产品相应的表的用户封禁状态置为1
2. my_freeze_manual为后台操作后可立即看到的数据表,其state代表操作状态（成功与否）
3. my_freeze表为前台展示用户封禁状态的封禁表
4. 管理员在后台进行解封操作时，会每个产品依次进行解封
5. 每款产品在解封时都会先判断（1）该用户账户是否被封，（2）该用户在其用户产品封禁表里有无封禁记录。如果没有记录，则默认已经解封，直接返回。这就是导致本次问题的原因：浏览器安全版的用户封禁表my_combo_user里面没有数据，造成了（2）结果，程序不继续执行，所以my_freeze表里的封禁状态没有被改变。但是程序认为这是正常的操作，所以执行最后更改了my_freeze_manual的状态，造成后台看数据被解封了，实际并没有的情况
6. 根本原因是，线上数据库里浏览器安全版的用户封禁表my_combo_user没有数据，原因是浏览器安全版和浏览器加速版的用户封禁信息都与浏览器标准版合并了，只有my_browser_user里面有数据，但是封禁和解封的脚本里没有及时更新

##### 解决方案
过滤掉浏览器加速版和安全版的条件判断
##### 影响范围
后台手动封禁解封用户操作