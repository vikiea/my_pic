# 大联盟业务问题总结
## 发现问题汇总
#### 每日汇总周增幅只显示8天内的数据问题
**QS:(任务ID：QT-16656 原始ID：133195)
http://qs.2345.net/action/tasks.php?act=detail&id=M2VmAQVQCnAJAgcJWwE=**
- **问题发现**

    【每日汇总】-【汇总数据】中，周增幅只能展示最近8天
- **原因排查**

    每日汇总获取列表时，默认获取15天之内的数据，且每页默认大小为15，然而在计算周增幅的时候是动态计算的，即取第15天与第8天的数据对比，依次类推，导致最后7天的周增幅数据为0

- **解决方案**

    将每页默认大小调整为40，可解决按月查询的结果展示

- **优化方案**

    第一种，考虑将每日汇总的周增幅数据按照之前的逻辑，将数据表里已有的周增幅字段复用，再与其他项目的周增幅对比取均值
第二种，取两次数据，第一次去1到15天，第二次取8到23天这种，再依次比较

#### 【财务系统】-【公司打款】-【公司打款详情】
**QS:(任务ID：QT-16656 原始ID：133195)
http://qs.2345.net/action/tasks.php?act=detail&id=M2VmAQVQCnAJAgcJWwE=**
- **问题发现**

    合并提单时，在有返利的情况下，财务在线中未展示返利金额明细
- **原因排查**

    合并提单时，将导航推广和导航返利合并成了同一类数据
- **解决方案**

    合并提单时区分导航和返利项目，分开上传数据
- **影响范围**

    大联盟数据与财务在线系统对接	
    
#### 【财务系统】-【个人支付】-【个人支付】
**QS:财务系统问题修复(任务ID：QT-17495 原始ID：136885)
http://qs.2345.net/action/tasks.php?act=detail&id=YzE2AQVQCnAJAgIAWgE=**
- **问题发现**

    合并提单时，在有返利的情况下，财务在线中未展示返利金额明细
- **原因排查**

    合并提单时，将导航推广和导航返利合并成了同一类数据
- **解决方案**

    合并提单时区分导航和返利项目，分开上传数据
- **影响范围**

    大联盟数据与财务在线系统对接	
    
## 问题优化汇总
#### 浏览器，看图王更换下载路径问题
**浏览器更换下载路径(任务ID：QT-16831 原始ID：134188)
http://qs.2345.net/index.php#action%2Ftasks.php%3Fact%3Ddetail%26id%3DODYxAQVQCnAJAgAJWgw%3D**
- **原因**

    部分浏览器，看图王推广包由于捆绑原因被运营商封禁，虽已解封但可能以后还会被封，故需更换下载路径防止此类情况再次发生

- **解决方案**
    1. 运维配合修改nginx重写规则，将下载路径中包含union[随机数]_common,union[随机数]_pic的字段，分别重定向为union_common,unionpic
    2. 服务端修改前端下载链接，将union_common改为union[随机数]_common的样式

- **下载包后台上传，前台下载整体流程**
    1. 后台》前后台管理》版本更新（此入口仅指定人可见，于代码中写死）上传更新包。代码逻辑为:
        1. product_version.php中执行上传操作，并将同步任务添加至计划任务脚本
        2. FtpUpload.php执行该计划任务,将运营上传的文件包通过ftp形式同步到下载服务器中
        3. 同步的路径相关信息在Fun.cls.php中进行配置
    2. 前台》获取代码》获取下载链接，点击“获取客户端”进行下载操作
        1. 前台下载链接配置信息在ExePack.php中
        2. 获取下载链接时，会将下载地址模板中指定的字符替换为用户uid,unionid，版本号等信息，同时对该文件中的相应下载链接添加随机数，防止路径被封禁
        3. 运维同步修改nginx重写规则，将链接中带有的随机数去掉，重定向到真实目录
- **操作时发现问题**
    - 看图王的上传路径为download.pic.2345.com,前台下载的域名也是download.pic.2345.com，但是线上并没有该域名的解析，故怀疑为历史遗留问题，将下载链接中的download.pic.2345.com改为download.2345.com

#### 用户【支付结算】里是有数据的，但是没有在【个人支付】里生成月付
- **问题发现**

    部分用户【支付结算】里是有数据的，但是在【个人支付】里没有该用户相关的月付记录信息
- **原因排查**

    该类用户的管理员财务身份具有部门助理和普通用户双重身份，当其作为普通用户时，其管理员身份为无，故在数据运算中被过滤掉
    
- **解决方案**

    修改该管理员的管理员身份为联盟发展部，重跑其下指定用户的支付数据即可

#### 财务系统，成本报表脚本运算问题
- **问题发现**

    财务说成本报表原来是15号跑数据，那边想改成10号跑，但是改完之后发现10号当天下午数据并没有跑
- **原因排查**

    首先排除是否是周末或节假日的问题，10号是周二，且不在大联盟后台周末发布的列表里。经代码逐行分析，发现原来的脚本是默认16号跑15号的数据，即前一天，有些第三方的软件会单独配置，可能跑前两天或者前三天的数据。所以正常10的数据应该是在11号的下午4点跑出
    
- **解决方案**

    看运营需求，是否需要改动，个人觉得不需要
    
#### 服务商打款问题排查
- **问题发现**

    运营说下载服务商打款文件的时候除了当天的文件，之前下载过的文件也被重新下载回来了
- **原因排查**

    看了之前几个月的数据文件，总结规律发现，运营每点一次下载，都会重新生成当天跑出来的数据文件。所以优先考虑文件下载的时候把该月生成过的文件重新打包下载一遍，但是经过代码逐行排查发现并没有这种情况，下载打包的逻辑没有问题，也只对当天跑出的数据进行了打包操作，并下载。最终从一个细节中发现根本原因，打包上传zip文件的时候，open方法的参数用了`ZIPARCHIVE::CREATE`,即没有就创建，有了就追加，导致文件每次被下载时都会包含之前下载过的文件
- **解决方案**

    看运营需求，是否需要改动，毕竟这块代码很长时间了也没被报出问题。如果改的话只需把`ZIPARCHIVE::CREATE`替换成`ZIPARCHIVE::OVERWRITE`即可
    
#### 静默包改便捷包问题
- **问题发现**

    之前有QS说要把大联盟内的静默包名称全部改为便捷包，导致了一个问题：浏览器那边的包在静默安装时失败
- **原因排查**
    经排查发现，浏览器端与大联盟这边通过接口对接时对包类型的判断是通过文本类型直接传输的，如“静默包”类型，“可选静默包”类型，“普通包”类型，静默包更改为便捷包后导致他们那边验证不一致，从而安装失败
    
- **解决方案**

    浏览器端配合修改将所有静默字眼改为便捷 
    
#### 杨杰元旗下客户信息展示问题
- **问题发现**

    李佳燕将名下部分客户划分到杨杰元名下，这部分客户的数据中，浏览器产品杨杰元只能看到2018年5月之前的数据，之后的数据无法查看，其他产品数据没问题
- **原因排查**
    18-05-21之前这些客户的管理员身份为2（联盟）， 李佳燕之前的管理员类型为3（非联盟），所以在18-05-21之后其客户管理员类型都是3，而杨杰元管理员类型是2，导致在筛选列表时，过滤掉了05-21之后的数据。其他产品没问题是因为其他产品未加该 
    
- **解决方案**
    1. 由于管理员类型这项目前基本不用了，为避免改动造成不可控影响，所以直接将杨杰元身份改为超级管理员即可，此超级管理员不会跟财务身份里的超级管理员冲突，本身没有实际意义    
    2. 也可以通过改代码方式，在分配客户的时候将该客户之前是用户类型数据批量改为当前用户的即可，但由于不知道之前为什么这么设计，所以不建议

#### 成本报表有效Mac安装量问题
- **问题发现**

    大联盟财务系统成本报表中，2345加速浏览器、2345王牌输入法、浏览器项目部的有效mac总量由于未知问题为0，问题排查
- **原因排查**
    经排查发现，之前有一需求要隐藏每日汇总中上面三款软件的有效Mac字段的展示，然而注释的那行代码同时被成本报表数据运算时用到，作用为调用backUnionData方法，获取数据后将其插入至财务库中相应的tab_{item}表中，由于该行代码被注释，导致数据为空 
    
- **解决方案**
    取消代码注释，同时将不想在每日汇总展示的字段，在取出数据后，手动unset掉
    