# 移动联盟1.1版本上线总结回顾
## 上线问题总结
### 老用户福利初始化脚本执行过慢
#### 问题现象
代码发布源站后，执行老用户初始化脚本，发现任务上报速度很慢，严重影响上线速度
#### 问题排查
##### 初次排查
1. 查看源站119CPU负载，很低，考虑非CPU问题
2. 发现MySQL查询走209从库，MySQL负载占用很高，考虑到209机器太老性能不够，初次判断是主从的问题

##### 初次解决方案
将脚本改为查152主库，同时将进程数加至14

##### 结果
152负载上来了，但是执行速度依然很慢，mq上报速度为0.6/s。从结果看，问题与主从无关

##### 其他可能原因
1. 网络延迟：公司为万兆网且为内网传输，基本不存在
2. 日志写入过多：测试环境写的日志更多，但无此情况
3. 多进程同时查询相同数据表，查询等待时间过长：MySQL进程没有积压
4. 索引问题？通过查各项目的日志表，发现uid没有建索引，考虑从这里下手

##### 最终解决方案
临时对uid添加索引。
#### 验证结果
mq上报速度瞬间增至80/s，所有数据在五分钟内消费完成。
#### 问题疑问
开发和测试环境比同样没有索引，且配置比源站要低的多，为什么就能在两个小时之内完成？而源站要十几个小时？
#### 问题总结
之所以出现这种问题，终其原因还是考虑的不够全面，一开始重点考虑性能瓶颈是在于进程的单一性，而忽略了其他方面的优化考虑。另一方面，因为在本地跟测试环境虽然执行较慢，但两个小时的执行时间在可接受的范围内，且预想线上的服务器性能要高出好几倍，也就没有去深入优化的动力。所以在以后的开发过程中，还是应该尽可能多的去考虑优化方案，这样才不会在异常情况发生时显得手忙脚乱

### 生产环境发布后出现成长值明细4G网络大概率获取不到数据的情况
#### 问题现象
用户登录查看成长值明细，在公司WiFi网络下几乎没有问题，但是4G网络下出现大概率获取不到成长值列表的情况
#### 问题排查
##### 可能原因
1. 中台对移动联盟web集群有部分IP没放开
2. 中台方返回数据不稳定
3. 我方在调中台接口出现异常
4. 部分web机异常，在请求落到该机器时导致返回数据为空

##### 问题排查
1. 针对可能原因1，查看中台限制访问白名单里是有所有移动联盟机器的，原因排除
2. 针对问题2，3，4，通过kibanna查看接口日志以及线上调试，发现会有部分请求出现调用curl库返回异常的情况，我方http组件将异常捕获后返回10000错误，业务将10000错误转换为200然后返回空数据，从而达到对用户无感知的效果
3. 最终发现web集群中108机器错误日志明显比其他机器多，同时考虑到该机器比其他机器系统版本要低很多，于是进行深入排查，将该机器从web集群移除，再次测试，问题得到解决

#### 问题原因
108机器版本较老，对新版curl的新特性不支持，导致我方对中台发起curl请求时返回异常
#### 解决方案
暂时关停108机器，待找到具体问题点之后再重新启用
#### 问题总结
这种因为环境产生的线上问题很难排查，也无法通过线下测试找出，只能遇到具体问题临时查找解决方案

### 线上修改及创建表结构遗漏
#### 问题发现
代码上线完成后，在回归验证时发现有部分表结构线上未创建的情况，导致可能会对线上运算造成影响
#### 问题解决
临时提QS进行线上表结构修补
#### 问题总结
在上线前检查的时候不够心细，一次性需要变动的有七十多张表，且创建时间跨度很长，确实很容易遗漏，但另一个原因为，数据表检查由两个人共同完成，容易造成自以为“我考虑不到的对方一定考虑到了”这种小聪明，这个是我需要自我反省的一个地方，也需要大家以后提高警惕
### 线上部分用户出现签到完成但签到列表未更新的情况
#### 问题发现
部分用户反馈其登录后出现线上签到完成且有成长值，但签到列表依然显示未签到的情况
#### 问题排查
##### 可能原因
1. 签到信息入库失败
2. 代码逻辑错误
3. redis缓存数据删除失败，导致缓存未更新
4. redis删除成功但立即又生成一份空的

##### 问题排查
1. 线上数据库查询得知该用户是有签到信息的，排除
2. 通过查看代码，再次确定逻辑并无异常,排除
3. 针对3和4，让运维帮忙查询了线上的redis缓存，发现缓存列表确实是空的，想到用户签到接口更等级接口几乎是同时请求的，于是怀疑是否是主从延迟的问题

##### 问题解决
临时让运维把今日签到用户的列表缓存清空，重新进等级列表发现签到列表恢复正常，于是3排除，确定就是主从延迟导致的这个问题
##### 问题总结
在这种对数据时效性要求同步高的场景，要多考虑主从延迟带来的影响，避免数据不一致造成的类似问题