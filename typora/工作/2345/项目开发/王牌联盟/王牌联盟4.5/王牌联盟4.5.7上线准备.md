# 王牌联盟4.5.7上线准备

## SQL变更记录

```sql
ALTER TABLE `my_2345`.`oanew_technician` 
ADD INDEX `bind_time`(`bind_time`) USING BTREE; 

SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for oanew_transfer_apply
-- ----------------------------
DROP TABLE IF EXISTS `oanew_transfer_apply`;
CREATE TABLE `oanew_transfer_apply` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键自增ID',
  `code` varchar(14) NOT NULL DEFAULT '' COMMENT '编号',
  `approval_id` int(11) DEFAULT '0' COMMENT '当前审批人审批表id',
  `tech_uid` int(11) NOT NULL COMMENT '被操作技术员uid',
  `apply_uid` int(11) NOT NULL COMMENT '转移发起人uid',
  `apply_puid` int(11) NOT NULL COMMENT '申请人所属区经uid',
  `apply_regional_id` int(11) NOT NULL DEFAULT '0' COMMENT '申请人所在大区id',
  `apply_company_id` int(11) NOT NULL DEFAULT '0' COMMENT '申请人所在区域（省公司）id',
  `state` tinyint(4) NOT NULL DEFAULT '1' COMMENT '审批状态 1 处理中 2 已通过 3 已驳回 4 已终止',
  `from_uid` int(11) DEFAULT NULL COMMENT '转移前维护人uid',
  `from_province_id` int(11) DEFAULT NULL COMMENT '转移前省ID',
  `from_city_id` int(11) DEFAULT NULL COMMENT '转移前市ID',
  `from_area_id` int(11) DEFAULT NULL COMMENT '转移前区ID',
  `from_cn_name` varchar(150) DEFAULT NULL COMMENT '转移前省市区中文名称，以|分割',
  `to_uid` int(11) DEFAULT NULL COMMENT '转移后维护人uid',
  `to_province_id` int(11) DEFAULT NULL COMMENT '转移后省ID',
  `to_city_id` int(11) DEFAULT NULL COMMENT '转移后市ID',
  `to_area_id` int(11) DEFAULT NULL COMMENT '转移后区ID',
  `to_cn_name` varchar(150) DEFAULT NULL COMMENT '转移后省市区中文名称，以|分割',
  `reason` varchar(200) DEFAULT '' COMMENT '转移理由',
  `revoke_time` datetime DEFAULT NULL COMMENT '终止时间',
  `revoke_reason` varchar(200) DEFAULT NULL COMMENT '终止原因',
  `revoke_type` tinyint(1) NOT NULL DEFAULT '0' COMMENT '终止类型 0无意义 1申请人撤销 2申请人离职 3审核人离职',
  `created_at` datetime NOT NULL DEFAULT '1000-00-00 00:00:00' COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `uk_code` (`code`) USING BTREE,
  KEY `idx_ctime` (`created_at`) USING BTREE,
  KEY `idx_tech_uid` (`tech_uid`) USING BTREE,
  KEY `idx_apply_uid` (`apply_uid`) USING BTREE,
  KEY `idx_from_uid` (`from_uid`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='转移申请记录表';

-- ----------------------------
-- Table structure for oanew_transfer_approval
-- ----------------------------
DROP TABLE IF EXISTS `oanew_transfer_approval`;
CREATE TABLE `oanew_transfer_approval` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键自增ID',
  `apply_id` int(11) NOT NULL COMMENT '转移申请记录表ID',
  `level` tinyint(4) NOT NULL COMMENT '审核级别 1 2 3 4',
  `approval_uid` int(11) DEFAULT NULL COMMENT '审核人uid',
  `approval_time` datetime DEFAULT NULL COMMENT '审核时间',
  `comment` varchar(500) DEFAULT NULL COMMENT '备注',
  `state` tinyint(4) NOT NULL DEFAULT '1' COMMENT '审批状态',
  `operator` varchar(20) DEFAULT NULL COMMENT '操作人',
  `created_at` datetime DEFAULT '1000-00-00 00:00:00' COMMENT '开始时间',
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_apply_id` (`apply_id`) USING BTREE,
  KEY `idx_uid` (`approval_uid`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='转移审批表';

SET FOREIGN_KEY_CHECKS = 1;
```

## 定时脚本
```crontab
#生成技术员信息下载文件 每天早上9点到晚上8点隔10分钟执行一次
*/10 9-20 * * * /opt/app/php/bin/php -c /opt/app/php/etc/cron.ini /opt/case/jfnew.2345.com/artisan gendownfile_command 
```

## nginx配置调整

```conf
location /adminh5/ {
    alias /opt/case/jfnew.2345.com/front/dist/;
}

location /cityoa/ {
    alias /opt/case/jfnew.2345.com/front/cityoa/;
}
```

## 其他待办
- 中台权限产品配置
- 确保权限开关已打开
- 确保上线没问题后让运维删除根目录下dist目录
- OAM转移技术员入口关闭